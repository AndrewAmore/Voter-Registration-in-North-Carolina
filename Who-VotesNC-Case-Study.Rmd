---
title: |
  | \vspace{-1.4cm} \textbf{Analyzing Voter Registration in the 2016 Presidential Election} \vspace{-0.5cm}
author: Andrew Amore 
date: |
  | \vspace{-0.6cm} \small 2022-11-21
output: pdf_document
urlcolor: blue
fontsize: 11pt
geometry: "left=2cm,right=2cm,top=1.5cm,bottom=1.5cm"
subparagraph: yes
header-includes: |
  \usepackage{titlesec}
  \titlespacing{\title}{0pt}{\parskip}{-\parskip}
  \titlespacing{\section}{0pt}{12pt plus 2pt minus 1pt}{0pt plus 1pt minus 1pt}
  \titlespacing{\subsection}{0pt}{12pt plus 2pt minus 1pt}{0pt plus 1pt minus 1pt}
  \titlespacing{\subsubsection}{0pt}{12pt plus 2pt minus 1pt}{0pt plus 1pt minus 1pt}
---

\vspace{-1.1cm}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include=FALSE, echo=FALSE, warning=FALSE, 
                      message=FALSE, fig.align = "center")
library(tidyverse)
library(rstan)
library(brms)
library(ggmcmc)
library(ggthemes)
library(ggridges)
library(bayesplot)
library(tidybayes)
library(coda)
library(arm)
library(ggpubr)     # panel plotting
library(rcompanion) # for correlation computation with categorical variables

source("utilities.R")

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

```{r, data-load-and-clean}
## CENSUS DATA ##
census = read.table(file="./data/Census2010_long.txt", header = TRUE)

# clean data
## combine NativeHawaiianOrOtherPacificIslanderAlone and SomeOtherRaceAlone to match voter_stats
census = census %>% 
  filter(Race %in% c("NativeHawaiianOrOtherPacificIslanderAlone", "SomeOtherRaceAlone")) %>%
  group_by(Geography, Age, Gender, Hispanic) %>% 
  summarise(freq_sum = sum(Freq)) %>% 
  mutate(Race = "SomeOtherRaceAlone") %>% 
  inner_join(census, by= c("Geography")) %>%
  distinct(Geography, Age.x, Gender.x, Hispanic.x, Race.x, freq_sum, TotalCountyPopulation) %>%
  rename("Age" = "Age.x", "Gender" = "Gender.x", "Hispanic" = "Hispanic.x", "Race" = "Race.x", "Freq" = "freq_sum") %>%
  relocate(Freq, .after = Race) %>%
  union(census %>% filter(!Race %in% c("NativeHawaiianOrOtherPacificIslanderAlone", "SomeOtherRaceAlone"))) %>%
  ungroup()

## VOTER REGISTRATION DATA ##
voter_stats = read.table(file="./data/voter_stats_20161108.txt", header = TRUE, na.strings=c("", " ", NA))
## democrat, libertarian, republican, unaffiliated

# clean data
voter_stats = voter_stats %>% 
  # reformat age to match
  mutate(Age = case_when(
    age == "Age 18 - 25" ~ "18-25",
    age == "Age 26 - 40" ~ "26-40",
    age == "Age 41 - 65" ~ "41-65",
    TRUE ~ "66+")) %>%
  # rename county to match
  rename("Geography" = "county_desc") %>%
  # reformat ethnicity
  mutate(Hispanic = case_when(
    ethnic_code == "NL" ~ "NotHispanic",
    ethnic_code == "HL" ~ "Hispanic",
    TRUE ~ "Undesignated")) %>%
  ## one unmatched field between sources (NativeHawaiianOrOtherPacificIslanderAlone)
  mutate(Race = case_when(
    race_code == "W" ~ "WhiteAlone",
    race_code == "B" ~ "BlackAlone",
    race_code == "O" ~ "SomeOtherRaceAlone",
    race_code == "U" ~ "Undesignated",
    race_code == "I" ~ "AmericanIndianOrAlaskaNativeAlone",
    race_code == "A" ~ "AsianAlone",
    race_code == "M" ~ "TwoOrMoreRaces",
    TRUE ~ "Undesignated")) %>%
  ## one unmatched field (U)
  mutate(Gender = case_when(
    sex_code == "F" ~ "Female",
    sex_code == "M" ~ "Male",
    TRUE ~ "Unknown")) %>% 
  dplyr::select(-age, -ethnic_code, -race_code, -sex_code) %>%
  ## aggregate by county
  group_by(Geography, party_cd, Age, Gender, Hispanic, Race) %>%
  summarise(VoterFreq = sum(total_voters)) %>%
  ungroup()

## PARTY NUMBERS ##
### this probably isn'r relevant as it looks to contain the same information as the
### voter stats file
party_df = read.table(file="./data/party_count.txt", skip = 5, sep = ",", 
                      col.names = c("county", "democrat", "republican", "green", 
                                    "constitution", "libertarian", "unaffiliated",
                                    "white", "black", "american indian", "native hawaiian",
                                    "other", "hispanic", "male", "female", "total"))
## subset to only relevant party counts, pivot and adjust values to match
party_df = party_df %>%
   dplyr::select(county, democrat, republican, libertarian, unaffiliated) %>%
  pivot_longer(!county, names_to = "party", values_to = "party_cnt") %>%
  mutate(party_cd = case_when(
    party == "democrat" ~ "DEM",
    party == "republican" ~ "REP",
    party == "libertarian" ~ "LIB",
    TRUE ~ "UNA"
  )) %>%
  dplyr::select(-party) %>%
  relocate(party_cd, .before=party_cnt)
```

## *Abstract*
*Political candidates are often interested in understanding factors influencing
voter registration rates across different demographic categories and how they 
effect overall registration probability. Understanding these aspects can better 
inform campaign staffs on election related decisions, like where to focus limited
advertising budgets.*

*To conduct an analysis, official voter registration records and census population 
estimates for counties in North Carolina were collected and analyzed using Bayesian
hierarchical modeling strategies to better quantify estimate uncertainty across 
different geographies. The final model indicates...*
<!-- more here once completed... -->

## Analysis

**Introduction**  
Political campaigns analyze historical election data to understand how different
demographic groups register to vote, specifically during presidential election
years when individuals are more likely to show up at the polls. This information 
can inform optimal advertising strategies, which can drum up more votes and win 
elections. Campaigns are generally interested in assessing registration differences 
amongst demographic groups and how registration tendencies vary by county, gender, 
age and party affiliation.

**Dataset Overview**  
To address the main questions of interest, two data sources were analyzed. 
Information from the [2010 U.S. Census](https://www.census.gov/data.html) was 
collected from the Federal Census Bureau website and enhanced with official
[2016 voter registration](https://vt.ncsbe.gov/) records from North Carolina. To 
combine the data, demographic field values were standardized, as the coding structure
varies slightly between State and Federal agencies. Field values without a corresponding
match were dropped from the analysis. For example, Census estimates quantify
two genders (male/female) while registration records include a third unknown 
category. Irrelevant registration fields denoting precinct location were also
removed. Metadata information for the combined dataset and a sample observation, 
can be viewed in Table 1.

```{r, show-metadata, include=TRUE, fig.height=3.5}
## ignore U issue and drop out
model_df = voter_stats %>% 
  inner_join(census)

# compute features
## factorize
model_df$Age = as.factor(model_df$Age)
model_df$Gender = as.factor(model_df$Gender)
model_df$Hispanic = as.factor(model_df$Hispanic)
model_df$Race = as.factor(model_df$Race)
model_df$PartyCd = as.factor(model_df$party_cd)
model_df = model_df %>% dplyr::select(-party_cd)

## several instances where voter_freq > than CensusFreq...people either travel to polls or 2010 census data doesn't reflect population at 2016 election
model_df$VoterTurnout = model_df$VoterFreq/model_df$TotalCountyPopulation
model_df = model_df %>% filter(Freq > 0)

set.seed(7777)
options(scipen=999)
options(digits = 3)
sample = model_df %>% slice_sample(n=1)

tbl_df = data.frame(
    Column.Names = colnames(model_df),
    Column.Description = c(
      "County in North Carolina",
      "Age Demographic Category",
      "Gender Demographic Category",
      "Demographic Indicator of Hispanic Origin",
      "Race Demographic Category",
      "Number of Registered Voters in Specified Demographics",
      "Total Population Count for Specified Demographics",
      "Total County Population",
      "Political Party Affiliation",
      "County Registration Percentage"
    ),
    Sample = t(sample)
)

ggtexttable(tbl_df, rows=NULL, cols = c("Field Name", "Description", "Sample"),
                  theme=ttheme("classic", base_size = 9, padding=unit(c(5,5), "mm"))) %>%
  table_cell_font(row = 2:(nrow(tbl_df) + 1), column = 1, face = "bold", size = 8) %>%
  table_cell_font(row = 2:(nrow(tbl_df) + 1), column = 2, face = "italic", size = 8) %>%
  table_cell_font(row = 2:(nrow(tbl_df) + 1), column = 3, face = "italic", size = 8) %>%
  tab_add_title(text = "Table 1: Metadata Information", size = 9, face = "plain",
                padding=unit(c(1,0), "mm"))
```

**Population Migration**  
The 2010 Census is assumed to represent the voter population during the 2016 
election, however, almost 10% of observations have more registered voters than
the demographic population estimates from the Census. Are we observing potential
voter fraud or is the Census information too old to reflect accurate population
densities six years later? Both examples in Table 2 have relatively small differences,
but suggest additional exploration is warranted.

```{r, population-sample, include=TRUE, fig.height=1}
set.seed(7324)
options(scipen=999)
options(digits = 3)
sample = model_df %>% 
  filter(VoterFreq > Freq) %>% 
  slice_sample(n=2) %>% 
  dplyr::select(-TotalCountyPopulation, -VoterTurnout) %>%
  relocate(PartyCd, .before=VoterFreq)

ggtexttable(sample, rows=NULL,
                  theme=ttheme("classic", base_size = 9, padding=unit(c(3.5,3.5), "mm"))) %>%
  table_cell_bg(row = 2:(nrow(sample) + 1), column=7, linewidth = 1, fill="#FF9999", color = "black") %>%
  table_cell_bg(row = 2:(nrow(sample) + 1), column=8, linewidth = 1, fill="#FF9999", color = "black") %>%
  tab_add_title(text = "Table 2: Bad Data Sample", size = 9, face = "plain",
                padding=unit(c(1,1), "mm"))
```

To understand the magnitude of inaccurate estimates, the population difference 
(registered voters - demographic population) was computed for affected observations
and aggregated by county. Figure 1 shows summaries for geographies with more than five 
observations, for ease of viewing, and displays interesting results. First, several 
counties have large differences, defined as more than 100 individuals (red line),
indicating potentially significant population migration between 2010 and 2016.
However, **80%** of counties have median difference less than **50** (green line) 
and **50%** of counties have median difference less than **10** (blue line). These
relatively small differences, effecting only 10% of the total dataset, assuages any
concern of major population shifts over the six year period. To minimize MSE, 30 
counties (out of 100) were randomly selected using sampling weights inversely 
proportional to the percentage of faulty observations (registered voters $>$ 
demographic population). By introducing bias, we hope to reduce estimate variation
by steering our model to use counties with low numbers of faulty observations.
The final dataset still includes a smaller percentage of invalid observations and
voter registrations for these values were set to $\text{Demographic Population} - 1$.
An additional benefit of the sub-sampling strategy is a reduction in computational 
overhead for an MCMC sampler in Bayesian models allowing our models to run in a 
reasonable amount of time on a personal computer.

```{r, bad-data-boxplot, include=TRUE, fig.height=4, fig.cap="Registration Differences by County", fig.align='left', fig.asp=0.62}
## get df for boxplot
sample = model_df %>% 
  filter(VoterFreq > Freq) %>%
  mutate(diff = VoterFreq - Freq)

## remove counties with less than 5 observation to make plot easier to read
sample = sample %>% 
  inner_join(sample %>% group_by(Geography) %>% 
               count() %>% filter(n > 5), keep = FALSE) %>%
  dplyr::select(-n)

# ggplot(sample, aes(x = Geography, y=log(diff))) + 
ggplot(sample, aes(x = reorder(Geography, log(diff), mean), y=log(diff))) + 
    geom_boxplot(outlier.size = 0.1) + 
  ggtitle("Registration Differences by County") + ylab("Population Difference") +
  xlab("County") +
  theme_minimal() +
  geom_hline(yintercept = log(100), linetype="solid", color="darkred", size=0.4) +
  geom_hline(yintercept = log(50), linetype="solid", color="gold", size=0.4) +
  geom_hline(yintercept = log(10), linetype="solid", color="darkgreen", size=0.4) +
  theme(legend.position="none", 
        plot.title = element_text(hjust = 0.5),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.text = element_text(size = 10),
        axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  scale_y_continuous(breaks = log(c(1, 10, 50, 100, 500)),
                   labels = c(1, 10, 50, 100, 500))

## percent by county
# model_df %>%
#   filter(VoterFreq > Freq) %>%
#   group_by(Geography) %>% 
#   count() %>% inner_join(model_df %>% group_by(Geography) %>% summarize(total_cnt = n())) %>%
#   mutate(percent_bad = n/total_cnt)
```

```{r, compute-demographic-sample-frac}
(model_df %>% filter(Freq >=30) %>% count())$n / nrow(model_df)
```

```{r, sample-counties-modeling-df}
## use 1-bad_data_percent as sampling weight for county selection
weights = 1 - (model_df %>% group_by(Geography) %>% count() %>% inner_join(model_df) %>% filter(VoterFreq > Freq) %>% group_by(Geography, n) %>% count() %>% arrange(n) %>% mutate(bad_data_percent = nn/n))$bad_data_percent

counties = (model_df %>% group_by(Geography) %>% count() %>% inner_join(model_df) %>% filter(VoterFreq > Freq) %>% group_by(Geography, n) %>% count() %>% arrange(n) %>% mutate(bad_data_percent = nn/n))$Geography

## sample 
set.seed(1235)
samp = sample(counties, 30, replace = FALSE, prob = weights)

## for these voter_freq, set voter_freq = Freq - 1 (could also drop these records out)
model_df = model_df  %>%
  mutate(VoterFreq = case_when(
    VoterFreq >= Freq ~ (Freq - as.integer(1)),
    TRUE ~ VoterFreq))

## filter to relevant fields
model_df = model_df %>% 
  filter(Geography %in% samp)
```


**Motivating a Multilevel Model**  
To evaluate modeling decisions, like where to apply random effects, an exploratory 
data analysis (EDA) was conducted. We are interested in understanding how demographic 
covariates affect the number of registered voters ("successes") relative to respective 
population estimates ("trials"), suggesting a binomial model. Figure 2 is a split
plot of different binomial regressions on voter registration probability 
($\frac{registrations}{demographic \ population}$) for different demographic 
categories and color coded by county. 

The left plot fits regressions by county and age group. The substantially different
trend lines by group (age and county) suggest a **random slope**.
<!-- confirm this with another plot -->

The right plot fits regressions by county and race. The consistent slopes across 
counties for identical demographic groupings suggest a **fixed effect**.


<!-- Both plots indicate registration probability depends on demographic population, -->
<!-- evidenced by sloping trend lines, but appears to depend on the demographic grouping -->
<!-- (fixed effect). -->
<!-- think about this more. The model won't let Freq be a covariate
don't think just a fixed effect will account for postive & negative effect -->

Plots for additional covariates can by found in the Appendix, but findings are 
summarized here. Gender effects are consistent across geography and suggest a 
**fixed effect**. Party affiliation displays consistent trends, but the intercept 
varies by county suggesting a **random intercept**. Hispanic indicator shows 
consistent patterns and suggests a **fixed effect**.
<!-- need to def check if this should be linear...i think they should be looking at invlogit -->

```{r, dev-plots}
# ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
#        aes(x=Freq, y=VoterFreq/Freq, col=Geography, group=interaction(Age, Race, Geography))) +
#   geom_point(size = 1.2, alpha=.2) +
#   theme_minimal() +
#     theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
# geom_smooth(method = "glm", method.args = list(family = "binomial"), se=FALSE,
#             size=.8, alpha  = .2) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
#         axis.title.y=element_blank(),
#         axis.text.y=element_blank(),
#         axis.ticks.y=element_blank()) +
#   labs(subtitle = "Hispanic") +
#   ylab("Registered Voters") + xlab("Total Demographic Population")

# ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
#        aes(x=Freq, y=VoterFreq/Freq, col=Geography, group=interaction(Geography, Age))) +
#   geom_point(size = 1.2, alpha=alpha) + 
#   theme_minimal() +
#     theme(plot.title = element_text(hjust = 0.5),
#           plot.subtitle = element_text(hjust = 0.5), 
#           legend.position="bottom",
#           panel.border = element_rect(colour = "black", fill=NA, size=1)) +
#   geom_smooth(method = "glm", method.args = list(family = "binomial"), se=FALSE,
#             size=.6) +
#   labs(subtitle = "Age") + 
#   ylab("Registration Probability") + xlab("Total Demographic Population")
```

```{r, motivate-the-model, include=TRUE, fig.cap="Voter Registration Behavior", fig.height=4.5}
# ggplot(data=model_df %>% filter(Geography %in% c("WAKE", "MECKLENBURG", "BUNCOMBE")),
alpha = 0.05

## logistic regression
p1 = ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
       aes(x=Freq, y=VoterFreq/Freq, col=Geography, group=interaction(Geography, Age))) +
  geom_point(size = 1.2, alpha=alpha) + 
  theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5), 
          legend.position="bottom",
          panel.border = element_rect(colour = "black", fill=NA, size=1)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se=FALSE,
            size=.6) +
  labs(subtitle = "Age") + 
  ylab("Registration Probability") + xlab("Total Demographic Population")

## by race
## logistic regression
p2 = ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
       aes(x=Freq, y=VoterFreq/Freq, col=Geography, group=interaction(Geography, Race))) +
  geom_point(size = 1.2, alpha=alpha) + 
  theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se=FALSE,
            size=.6) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1), 
        axis.title.y=element_blank(),
        legend.position = "none") +
  labs(subtitle = "Race") + 
  ylab("Registered Voters") + xlab("Total Demographic Population")


plot = ggarrange(p1,p2,ncol=2, nrow=1, common.legend = TRUE, legend="bottom", 
                 widths = c(1.05,0.95))
annotate_figure(plot, top = text_grob("Voter Registration vs. Demographic Population"
                                      , face = "bold", size = 13))
```

```{r, categorical-correlation-matrix}
corr_df = model_df %>% 
  dplyr::select(Age, Gender, Hispanic, Race, PartyCd)
compute_corr(corr_df)
```

**Model Specification**  
The modeling framework can now be specified as follows. Let $\left(y_{ijk}, n_{ijk}, p_{ijk}\right)$
denote the number of voter registrations, demographic population and registration 
probability respectively for county $i$, age group $j$ and vector of fixed effect 
covariates $k$. $y_{ijk}$ is assumed to be distributed as a binomial random variable.
$$y_{ijk} \sim Binomial\left(n_{ijk}, \ p_{ijk}\right)$$

Individuals can only register to vote once, but binomial trials sample independently
with replacement. The independent draw assumption seems reasonable, as the probability 
of any one individual registering to vote is most likely independent of any other 
individual's decision (more on this later). Additionally, $\sim 70\%$ of demographic
categories in our dataset have populations $n_{ijk} \geq 30$. However, the demographic 
samples can be considered population estimates and may warrant a hypergeometric 
distribution, but this induces a dependence between $y_{ijk}$'s which is unwarranted
based on our independent registration assumption. Under the binomial model, several 
multilevel structures with varying complexity were evaluted. Table 3 displays the 
specifications.

<!-- The EDA suggests variation across counties, age groups and political -->
<!-- affiliations, but how does the covariance structure affect coefficient estimates? -->

```{r, random-effect structure, include=TRUE, fig.height=2}
tbl_df = data.frame(
    Fixed.Effects = c(rep("Gender, Hispanic, Race, PartyCd, Age", 4)),
    Random.Intercept = c(rep("Geography", 3), "Geography, Age, PartyCd"),
    Random.Slope = c("", "Age", "Age, PartyCd", "Age")
)

ggtexttable(tbl_df, rows=c("Model I ", "Model II ", "Model III ", "Model IV "), 
            cols = c("Fixed Effect Fields", "Random Intercept Fields", "Random Slope Fields"),
                  theme=ttheme("classic", base_size = 9, padding=unit(c(5,5), "mm"))) %>%
  # table_cell_font(row = 2:(nrow(tbl_df) + 1), column = 1, face = "bold", size = 6.5) %>%
  # table_cell_font(row = 2:(nrow(tbl_df) + 1), column = 2, face = "italic", size = 6.5) %>%
  # table_cell_font(row = 2:(nrow(tbl_df) + 1), column = 3, face = "italic", size = 6.5) %>%
  tab_add_title(text = "Table 3: Random Effect Structures", size = 9, face = "plain",
                padding=unit(c(1,0), "mm"))
```

**Model I**  
Let $\mu$ denote a global intercept, $\theta_{i}$ a **County** random effect
intercept for observations in county $i$, $X_k,[ij]$ a vector of demographic indicator
variables (gender, ethnicity, race, party affiliation and age) and $\beta$ the 
corresponding fixed effect estimates.
$$Logit(p_{ijk})) = \mu + \theta_{i} + X_{k[ij]}\beta$$
_Prior Specifications_
$$\mu \sim N\left(0,1\right), \ \beta \sim N\left(0, 1\right), \ \theta_{i} \sim N\left(0, \sigma\right)$$
$$\sigma \sim HalfCauchy\left(0, \frac{1}{2}\right)$$

```{r, fit-model-1}
m1 = brm(data = model_df, family = "binomial",
      VoterFreq | trials(Freq) ~ 1 + Gender + Hispanic + Race + PartyCd + Age + (1 | Geography),
      prior = c(prior(normal(0, 1), class = "Intercept"),
                prior(normal(0, 1), class = "b"),  ## class b denotes population (fixed) effects
                prior(cauchy(0, 0.5), class = "sd")  ## group effects
                ),
      file = "models/m1.rds",
      iter = 2500, 
      warmup = 500,
      chains = 4)
summary(m1)
```

**Model II**  
Model II is an extension with a new random effect for **Age**. Let $a_{ij,[k]}$ 
denote the age category, $j$, for observations in county $i$ and $\Gamma_{ij}$ 
the random effect.
$$Logit(p_{ijk})) = \mu +  \theta_{i} + a_{ij [k]}\Gamma_{ij} + X_{k [ij]}\beta$$
_Additional Prior Specifications_
$$\Gamma_{ij} \sim N\left(0, \gamma\right), \ \gamma \sim HalfCauchy\left(0, \frac{1}{2}\right)$$

```{r, fit-model-2}
m2 = brm(data = model_df, family = "binomial",
      VoterFreq | trials(Freq) ~ 1 + Gender + Hispanic + Race + PartyCd + Age + (1 + Age | Geography),
      prior = c(prior(normal(0, 1), class = "Intercept"),
                prior(normal(0, 1), class = "b"),  ## class b denotes population effects
                prior(cauchy(0, 0.5), class = "sd")  ## group effects
                ),
      file = "models/m2_logistic_regression_party_cd.rds",
      iter = 2500, 
      warmup = 500,
      chains = 4)
```

**Model III**  
Model III is an extension of II with an additional random effect for **Party Affiliation**.
Let $q_{ip,[jk]}$ denote the party, $p$, for observations in county $i$ and 
$\Omega_{ip}$ the random effect.
$$Logit(p_{ijkp})) = \mu +  \theta_{i} + a_{ij [k]}\Gamma_{ij} + q_{ip [jk]}\Omega_{ip} + X_{k [i,j]}\beta$$
_Additional Prior Specifications_
$$\Omega_{il} \sim N\left(0, \omega\right), \ \omega \sim HalfCauchy\left(0, \frac{1}{2}\right)$$

```{r, fit-model-3}
m3 = brm(data = model_df, family = "binomial",
      VoterFreq | trials(Freq) ~ 1 + Gender + Hispanic + Race + PartyCd + Age + (1 + Age + PartyCd | Geography),
      prior = c(prior(normal(0, 1), class = "Intercept"),
                prior(normal(0, 1), class = "b"),  ## class b denotes population effects
                prior(cauchy(0, 0.5), class = "sd")  ## group effects
                ),
      file = "models/m3_logistic_regression_age_party_cd_slope.rds",
      iter = 3000, 
      warmup = 500,
      chains = 4)
```

**Model IV**  
Model IV is an extension of II with an additional random effects for **Age**,
$\alpha_{j}$, and **Party Affiliation**, $\zeta_{p}$.

$$Logit(p_{ijlk})) = \mu + \theta_{i} + \alpha_{j} + \zeta_{p} + a_{ij [k]}\Gamma_{ij} + X_{k [i,j]}\beta$$

_Additional Prior Specifications_
$$\alpha_{j} \sim N\left(0, \sigma_{\alpha}\right), \ \zeta_{p} \sim N\left(0, \sigma_{\zeta}\right)$$
$$\sigma_{\alpha}, \sigma_{\zeta} \sim HalfCauchy\left(0, \frac{1}{2}\right)$$


```{r, fit-model-4}
# m4 = brm(data = model_df, family = "binomial",
#       VoterFreq | trials(Freq) ~ 1 + Gender + Hispanic + Race + PartyCd + Age + (1 + Age | Geography) + (1 | Age) + (1 | PartyCd),
#       prior = c(prior(normal(0, 1), class = "Intercept"),
#                 prior(normal(0, 1), class = "b"),  ## class b denotes population (fixed) effects
#                 prior(cauchy(0, 0.5), class = "sd")  ## group effects
#                 ),
#       file = "models/m4.rds",
#       iter = 2500, 
#       warmup = 500,
#       chains = 4)
## more iterations
m4 = brm(data = model_df, family = "binomial",
      VoterFreq | trials(Freq) ~ 1 + Gender + Hispanic + Race + PartyCd + Age + (1 + Age | Geography) + (1 | Age) + (1 | PartyCd),
      prior = c(prior(normal(0, 1), class = "Intercept"),
                prior(normal(0, 1), class = "b"),  ## class b denotes population (fixed) effects
                prior(cauchy(0, 0.5), class = "sd")  ## group effects
                ),
      file = "models/m4_6000.rds",
      iter = 6000,
      warmup = 1000,
      chains = 5)
```

**Analysis**  
The main questions of interest concern demographic factors effecting registration
probabilities.

```{r, demographic-subgroup-analysis, include=TRUE}
m1_fxed = data.frame(fixef(m1), model="Model I")
m1_fxed$parameter = rownames(m1_fxed)
m1_fxed = m1_fxed %>% mutate(parameter = case_when(
  parameter == "PartyCdLIB" ~ "party_cdLIB",
  parameter == "PartyCdREP" ~ "party_cdREP",
  parameter == "PartyCdUNA" ~ "party_cdUNA",
  TRUE ~ parameter
))
m1_fxed = m1_fxed[2:nrow(m1_fxed),]
rownames(m1_fxed) = NULL

m2_fxed = data.frame(fixef(m2), model="Model II")
m2_fxed$parameter = rownames(m2_fxed)
m2_fxed = m2_fxed[2:nrow(m2_fxed),]
rownames(m2_fxed) = NULL

m3_fxed = data.frame(fixef(m3), model="Model III")
m3_fxed$parameter = rownames(m3_fxed)
m3_fxed = m3_fxed[2:nrow(m3_fxed),]
rownames(m3_fxed) = NULL

m4_fxed = data.frame(fixef(m4), model="Model IV")
m4_fxed$parameter = rownames(m4_fxed)
m4_fxed = m4_fxed %>% mutate(parameter = case_when(
  parameter == "PartyCdLIB" ~ "party_cdLIB",
  parameter == "PartyCdREP" ~ "party_cdREP",
  parameter == "PartyCdUNA" ~ "party_cdUNA",
  TRUE ~ parameter
))
m4_fxed = m4_fxed[2:nrow(m4_fxed),]
rownames(m4_fxed) = NULL

tst = rbind(m1_fxed, m2_fxed, m3_fxed, m4_fxed)

ggplot(tst, aes(x=Estimate, y=parameter, xmin = Q2.5, xmax = Q97.5, color=model)) +
# ggplot(tst, aes(x=Estimate, y=parameter)) +
  # geom_point(alpha=0.5, shape=1) +
  geom_pointinterval(alpha = 0.5, shape=1) +
  # geom_errorbar(aes(xmin=Q2.5, xmax=Q97.5, color=model), width=.1) +
  ggtitle("Population Estimates") +
  ylab("Fixed Effect") + xlab("Coefficient Estimate") + 
  theme(plot.title = element_text(hjust = 0.5)) + geom_vline(xintercept = 0)
```


```{r}
num_models = 4
model_names = c("Model I", "Model II", "Model III", "Model IV")
models = list(m1, m2, m3, m4)
tst = c()
for(i in 1:num_models){
  tst = rbind(tst, compute_fixed_effect_intervals(models[[i]], model_names[i]))
}

ggplot(tst, aes(x=Estimate, y=parameter, xmin = Q2.5, xmax = Q97.5, color=model)) +
# ggplot(tst, aes(x=Estimate, y=parameter)) +
  # geom_point(alpha=0.5, shape=1) +
  geom_pointinterval(alpha = 0.5, shape=1) +
  # geom_errorbar(aes(xmin=Q2.5, xmax=Q97.5, color=model), width=.1) +
  ggtitle("Population Estimates") +
  ylab("Fixed Effect") + xlab("Coefficient Estimate") + 
  theme(plot.title = element_text(hjust = 0.5)) + geom_vline(xintercept = 0)
```



**Assessing Model Fit & Comparing Models**


```{r}

```



<!-- How did different demographic subgroups register to vote in the 2016 elections? For example, how did the registration rate for males compare to the registration rate for females after controlling for other potential predictors? -->




```{r}
ggplot(tst %>% filter(model == "Model III"), aes(x=Estimate, y=parameter, xmin=Q2.5-0.1, xmax=Q97.5)) + 
  geom_pointinterval(size = 0.1) +
  ggtitle("Population Estimates") +
  ylab("Fixed Effect") + xlab("Coefficient Estimate") + 
  theme(plot.title = element_text(hjust = 0.5)) + geom_vline(xintercept = 0)



tst$odds_ratio_est = exp(tst$Estimate)

ggplot(tst %>% filter(model == "Model I"), aes(x=exp(Estimate), y=parameter, xmin=Q2.5, xmax=Q97.5)) + 
  geom_pointinterval(size = 0.1) +
  ggtitle("Population Estimates") +
  ylab("Fixed Effect") + xlab("Coefficient Estimate") + 
  theme(plot.title = element_text(hjust = 0.5)) + geom_vline(xintercept = 0)
```



<!-- Did the overall probability or odds of registering to vote differ by county in 2016? Which counties differ the most from other counties? -->

<!-- How did the registration rates differ between females and males for the different party affiliations? -->

<!-- How did the registration rates differ between age groups for the different party affiliations? -->


<!-- **Predictive Performance**   -->

```{r}
## nice to have...
# p = predict(m1) %>% 
#   as_tibble() %>% bind_cols(model_df)

## for each model how many estimates fall inside the CR
```


**Limitations**  
Several limitations have been mentioned throughout and are summarized. First,
we have concerns about the viability of the 2010 Census for population estimates
in 2016 as some observations have more voter registrations than population estimates.
A weighted sub-sampling strategy was introduced to minimize the statistical impact,
but only addresses detectable observations where $registration \ > \ population$.
A valid concern is that all demographic populations undergo some change over the
six year period. A potential solution is to impute or average the demographic populations
in 2016 using estimates from both the 2010 and 2020 Censuses.

Another limitation, is from the sub-sampling strategy that limits the model to
only $30\%$ of counties which makes our statistical estimates more variable. To 
leverage the entire dataset one can either acquire more computation or specify
simpler models that might not capture the true signal.


**Conclusion**  
Historical voting records and Census population estimates were used to evaluate 
demographic differences in registration tendencies. 



\newpage

## Appendix

```{r, additional-covariate-plots, include=TRUE}
## gender: consistent trends
ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
       aes(x=Freq, y=VoterFreq/Freq, col=Geography, group=interaction(Geography, Gender))) +
  geom_point(size = 1.2, alpha=.2) +
  theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
geom_smooth(method = "glm", method.args = list(family = "binomial"), se=FALSE,
            size=.8, alpha  = .2) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "none") +
  labs(subtitle = "Gender") +
  ylab("Registered Voters") + xlab("Total Demographic Population")

## partycd: similar trends
ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
       aes(x=Freq, y=VoterFreq/Freq, col=Geography, group=interaction(Geography, PartyCd))) +
  geom_point(size = 1.2, alpha=.2) +
  theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
geom_smooth(method = "glm", method.args = list(family = "binomial"), se=FALSE,
            size=.8, alpha  = .2) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "none") +
  labs(subtitle = "PartyCd") +
  ylab("Registered Voters") + xlab("Total Demographic Population")

## hispanic: similar trends
ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
       aes(x=Freq, y=VoterFreq/Freq, col=Geography, group=interaction(Geography, Hispanic))) +
  geom_point(size = 1.2, alpha=.2) +
  theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
geom_smooth(method = "glm", method.args = list(family = "binomial"), se=FALSE,
            size=.8, alpha  = .2) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "none") +
  labs(subtitle = "Hispanic") +
  ylab("Registered Voters") + xlab("Total Demographic Population")

# ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
#        aes(x=Freq, y=VoterFreq, col=Geography, group=interaction(Geography, Gender))) +
#   geom_point(size = 1.2, alpha=.9) + 
#   theme_minimal() +
#     theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
#   geom_smooth(method = lm, se=FALSE, size=.5, alpha  = .5) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
#         legend.position = "none") +
#   labs(subtitle = "Color by Geography & Fit by Gender") + 
#   ylab("Registered Voters") + xlab("Total Demographic Population")
# 
# ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
#        aes(x=Freq, y=VoterFreq, col=Geography, group=interaction(Geography, Hispanic))) +
#   geom_point(size = 1.2, alpha=.9) + 
#   theme_minimal() +
#     theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
#   geom_smooth(method = lm, se=FALSE, size=.5, alpha  = .5) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=1), legend.position = "none") +
#   labs(subtitle = "Color by Geography & Fit by Hispanic") + 
#   ylab("Registered Voters") + xlab("Total Demographic Population")
# 
# ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
#        aes(x=Freq, y=VoterFreq, col=Geography, group=interaction(Geography, PartyCd))) +
#   geom_point(size = 1.2, alpha=.9) + 
#   theme_minimal() +
#     theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
#   geom_smooth(method = lm, se=FALSE, size=.5, alpha  = .5) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=1), legend.position = "none") +
#   labs(subtitle = "Color by Geography & Fit by Political Party") + 
#   ylab("Registered Voters") + xlab("Total Demographic Population")

### the original linear regression plots...we don't want to use these
# ggplot(data=model_df %>% filter(Geography %in% c("WAKE", "MECKLENBURG", "BUNCOMBE")),
# alpha = 0.05
# p1 = ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
#        aes(x=Freq, y=VoterFreq, col=Geography, group=interaction(Geography, Age))) +
#   geom_point(size = 1.2, alpha=alpha) + 
#   theme_minimal() +
#     theme(plot.title = element_text(hjust = 0.5),
#           plot.subtitle = element_text(hjust = 0.5),
#           axis.title.x=element_blank(),
#           legend.position="bottom",
#           panel.border = element_rect(colour = "black", fill=NA, size=1)) +
#   geom_smooth(method = lm, se=FALSE, size=.6) +
#   # theme(legend.position="bottom", panel.border = element_rect(colour = "black", fill=NA, size=1)) +
#   labs(subtitle = "Age (Linear)") + 
#   ylab("Registered Voters") + xlab("Total Demographic Population")
# 
# ## by race
# p2 = ggplot(data=model_df %>% filter(Geography %in% c("JACKSON", "COLUMBUS", "LEE")),
#        aes(x=Freq, y=VoterFreq, col=Geography, group=interaction(Geography, Race))) +
#   geom_point(size = 1.2, alpha=alpha) + 
#   theme_minimal() +
#     theme(plot.title = element_text(hjust = 0.5),
#           axis.title.y=element_blank(),
#           axis.title.x=element_blank(),
#           plot.subtitle = element_text(hjust = 0.5)) +
#   geom_smooth(method = lm, se=FALSE, size=.6) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=1), 
#         legend.position = "none") +
#   labs(subtitle = "Race (Linear)") + 
#   ylab("Registered Voters") + xlab("Total Demographic Population")
# 
# plot = ggarrange(p1, p2, ncol=2, nrow=1, common.legend = TRUE, legend="top", 
#                  widths = c(1.05,0.95))
# annotate_figure(plot, top = text_grob("Voter Registration vs. Demographic Population"
#                                       , face = "bold", size = 13))
```



**Trace Plots**  

```{r, m1-trace-plots, include=TRUE}
m1df = ggs(m1)
# get the same plots without bayesplot...have to filter out the warmup!
m1df$Chain = factor(m1df$Chain)
# caterpillar trace plots
## only pick some paremeters for plotting
ggplot(filter(m1df, Parameter %in% c("b_Age66P", "b_GenderMale", "b_HispanicNotHispanic")),
       aes(x   = Iteration,
           y   = value,
           col = as.factor(Chain)))+
  theme_minimal() +
  geom_line() +
  geom_vline(xintercept = 500) + ## add vertical line at the default warm-up value 1000
  facet_grid(Parameter ~ . , scale  = 'free_y', switch = 'y') +
  labs(title = "Model I: Trace Plots", col   = "Chains")
```




